on:
  push:
  schedule:
    - cron: '0 0 * * *'

name: Salus security scan

jobs:
  go_stable_version:
    runs-on: ubuntu-latest
    name: Go Stable Version
    steps:
      - uses: actions/checkout@v2
      - id: go-supported-version
        uses: dopplerhq/go-supported-version@v1
        with:
          go-version-input: '1.21' # GO_VERSION_DEF

  semgrep:
    runs-on: ubuntu-latest
    name: Semgrep
    steps:
      - uses: actions/checkout@v2
      - name: Scan
        id: scan
        run: |
          set -eo pipefail;
          python3 -m pip install semgrep;
          semgrep scan --error --config https://semgrep.dev/p/trailofbits --config semgrep_configs

  salus_scan_job:
    runs-on: ubuntu-latest
    name: Salus Security Scan
    steps:
    - uses: actions/checkout@v2
    - name: Salus Scan
      id: salus_scan
      uses: federacy/scan-action@0.1.5
      env:
        SALUS_CONFIGURATION: "file://salus-config.yaml"
      with:
        report_uri: file://./salus-report.txt
        report_format: txt
    - uses: actions/upload-artifact@master
      if: failure()
      with:
        name: Scan results
        path: ./salus-report.txt
